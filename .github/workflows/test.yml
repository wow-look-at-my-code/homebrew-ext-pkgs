name: Test Formulas

on: push

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        formula:
          - bats-support
          - bats-assert
          - glibc@2.41
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Add tap
        run: |
          mkdir -p "$(brew --repository)/Library/Taps/wow-look-at-my-code"
          ln -s "${{ github.workspace }}" "$(brew --repository)/Library/Taps/wow-look-at-my-code/homebrew-ext-pkgs"

      - name: Audit formula
        run: |
          echo "==> Auditing ${{ matrix.formula }}"
          brew audit --strict "wow-look-at-my-code/ext-pkgs/${{ matrix.formula }}" || true

      - name: Install formula
        run: |
          echo "==> Installing ${{ matrix.formula }}"
          brew install "wow-look-at-my-code/ext-pkgs/${{ matrix.formula }}"

      - name: Test formula
        run: |
          echo "==> Testing ${{ matrix.formula }}"
          brew test "wow-look-at-my-code/ext-pkgs/${{ matrix.formula }}"
